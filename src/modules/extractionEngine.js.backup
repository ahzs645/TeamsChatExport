/**
 * Extraction Engine Module
 * Handles extraction coordination and orchestration between other modules
 */

import { TeamsVariantDetector } from './teamsVariantDetector.js';
import { MessageExtractor } from './messageExtractor.js';
import { ScrollManager } from './scrollManager.js';

export class ExtractionEngine {
  constructor() {
    this.messageExtractor = new MessageExtractor();
    this.scrollManager = new ScrollManager();
    this.DELAY_BETWEEN_CLICKS_MS = 2000; // 2 seconds. Increase if chats load slowly.
  }

  /**
   * Helper function to pause execution.
   */
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  /**
   * Gets auto-scroll setting
   */
  getAutoScroll() {
    return this.scrollManager.getAutoScroll();
  }

  /**
   * Sets auto-scroll setting
   */
  setAutoScroll(enabled) {
    this.scrollManager.setAutoScroll(enabled);
  }

  /**
   * Scrolls to the top of the chat to ensure all messages are loaded
   * Delegates to ScrollManager
   */
  async scrollToTopOfChat() {
    return await this.scrollManager.scrollToTopOfChat();
  }
  }

  /**
   * Converts relative timestamps to actual dates
   * Delegates to MessageExtractor
   */
  convertRelativeTimestamp(timestamp) {
    return this.messageExtractor.convertRelativeTimestamp(timestamp);
  }

  /**
   * Extracts detailed information for all visible messages in the chat pane.
   * Delegates to MessageExtractor
   */
  extractVisibleMessages() {
    return this.messageExtractor.extractVisibleMessages();
  }
    const extractedMessages = [];
    
    // Try multiple message container selectors for different Teams variants
    const messageSelectors = [
      '[data-tid="chat-pane-item"]',      // Classic/current
      '.fui-unstable-ChatItem',          // New Teams
      '.fui-ChatMessage',                // Fluent UI received messages
      '.fui-ChatMyMessage',              // Fluent UI sent messages
      '[data-tid="message"]',            // Generic
      '[role="article"]',                // ARIA role for messages
      '.message-container'               // Generic message container
    ];
    
    let messageContainers = [];
    
    for (const selector of messageSelectors) {
      const containers = document.querySelectorAll(selector);
      if (containers.length > 0) {
        messageContainers = containers;
        console.log(`üì® Using message selector "${selector}" - found ${containers.length} messages`);
        break;
      }
    }

    if (messageContainers.length === 0) {
      console.log('‚ùå No message containers found');
      return extractedMessages;
    }

    for (const container of messageContainers) {
      // Try multiple author selectors
      const authorSelectors = [
        '[data-tid="message-author-name"]',
        '.fui-ChatMessage__author',
        '.message-author',
        '[data-testid="message-author"]',
        'span[title*="@"]',
        '.author'
      ];
      
      let author = null;
      for (const sel of authorSelectors) {
        const el = container.querySelector(sel);
        if (el && el.textContent.trim()) {
          author = el.textContent.trim();
          break;
        }
      }
      
      // Try multiple timestamp selectors
      const timestampSelectors = [
        '.fui-ChatMessage__timestamp',
        '.fui-ChatMyMessage__timestamp', 
        '[data-tid="timestamp"]',
        '.timestamp',
        'time',
        '[title*=":"]'
      ];
      
      let timestamp = null;
      for (const sel of timestampSelectors) {
        const el = container.querySelector(sel);
        if (el) {
          timestamp = el.title || el.textContent.trim();
          if (timestamp) break;
        }
      }
      
      // Try multiple message body selectors
      const messageSelectors = [
        '.fui-ChatMessage__body',
        '.fui-ChatMyMessage__body',
        '[data-tid="message-body"]',
        '.message-body',
        '.message-content',
        'p', 'div[dir]'
      ];
      
      let message = null;
      for (const sel of messageSelectors) {
        const el = container.querySelector(sel);
        if (el && el.textContent.trim()) {
          message = el.textContent.trim();
          break;
        }
      }
      
      // Determine message type (sent vs received)
      let type = 'received';
      
      // Check multiple indicators for sent messages
      // Primary indicators for Fluent UI
      if (container.querySelector('.fui-ChatMyMessage__timestamp') ||
          container.querySelector('.fui-ChatMyMessage__body') ||
          container.classList.contains('fui-ChatMyMessage')) {
        type = 'sent';
      }
      
      // Secondary indicators - data attributes and classes
      if (container.classList.contains('sent') ||
          container.getAttribute('data-type') === 'sent' ||
          container.querySelector('[data-tid*="my-message"]') ||
          container.closest('[data-tid*="my-message"]') ||
          container.getAttribute('data-is-from-me') === 'true' ||
          container.classList.contains('me') ||
          container.classList.contains('self')) {
        type = 'sent';
      }
      
      // Additional check: if the message is aligned to the right or has specific styling
      const computedStyle = window.getComputedStyle(container);
      if (computedStyle.textAlign === 'right' || 
          computedStyle.justifyContent === 'flex-end' ||
          computedStyle.alignSelf === 'flex-end' ||
          computedStyle.marginLeft === 'auto' ||
          container.style.marginLeft === 'auto') {
        type = 'sent';
      }
      
      // Check parent container for sent message indicators
      const parentContainer = container.parentElement;
      if (parentContainer) {
        if (parentContainer.classList.contains('sent') ||
            parentContainer.classList.contains('me') ||
            parentContainer.getAttribute('data-from-me') === 'true') {
          type = 'sent';
        }
      }

      // Only include messages with at least author and message content
      if (message && message.length > 0) {
        // Use fallback values if author/timestamp missing
        const finalAuthor = author || 'Unknown User';
        const rawTimestamp = timestamp || new Date().toLocaleString();
        const convertedTimestamp = this.convertRelativeTimestamp(rawTimestamp);
        
        console.log(`üïê Timestamp conversion: "${rawTimestamp}" ‚Üí "${convertedTimestamp}"`);
        
        extractedMessages.push({ 
          author: finalAuthor, 
          timestamp: convertedTimestamp, 
          message: message, 
          type: type 
        });
      }
    }
    
    console.log(`üìù Extracted ${extractedMessages.length} messages`);
    return extractedMessages;
  }

  /**
   * Main extraction logic
   */
  async startExtraction(selectedChatItems) {
    console.log("üöÄ Starting detailed chat extraction...");

    const allConversations = {};
    console.log(`üìù Processing ${selectedChatItems.length} selected conversations`);

    for (const item of selectedChatItems) {
      // Get conversation name using multiple approaches
      let conversationName = TeamsDetection.getConversationName(item);

      if (conversationName) {
        console.log(`\n[->] Processing conversation: "${conversationName}"`);
        
        // Try multiple click strategies for Fluent UI
        let clicked = false;
        
        // Strategy 1: Look for the main clickable container (multiple selectors for different layouts)
        const containerSelectors = [
          '.fui-TreeItemLayout',
          '[data-inp*="chat-switch"]',
          '[data-inp*="collab-unified-chat-switch"]',
          '.fui-TreeItem-content',
          '[role="treeitem"] > div'
        ];
        
        for (const selector of containerSelectors) {
          const clickableContainer = item.querySelector(selector);
          if (clickableContainer && !clicked) {
            console.log(`üñ±Ô∏è Clicking Fluent UI container with selector: ${selector}`);
            clickableContainer.click();
            clicked = true;
            break;
          }
        }
        
        // Strategy 2: Try clicking the item itself if container click failed
        if (!clicked) {
          console.log('üñ±Ô∏è Clicking tree item directly');
          item.click();
          clicked = true;
        }
        
        await this.delay(this.DELAY_BETWEEN_CLICKS_MS);
        
        // Scroll to top to ensure we get all messages (if auto-scroll is enabled)
        if (this.settings.autoScroll) {
          await this.scrollToTopOfChat();
        }
        
        // Extract messages using New Teams selectors
        const messages = this.extractVisibleMessages();
        allConversations[conversationName] = messages;
        console.log(`    [‚úì] Extracted ${messages.length} detailed messages.`);
      } else {
        console.log(`‚ö†Ô∏è Skipping item - no conversation name found:`, item);
      }
    }

    console.log("\n\n‚úÖ --- EXTRACTION COMPLETE --- ‚úÖ");
    console.log(`üìä Total conversations extracted: ${Object.keys(allConversations).length}`);
    
    try {
      if (chrome.runtime && chrome.runtime.sendMessage) {
        chrome.runtime.sendMessage({action: "download", data: allConversations});
      } else {
        console.error("Extension context invalidated. Please refresh the page and try again.");
        alert("Extension context was invalidated. Please refresh the page and try again.");
      }
    } catch (error) {
      console.error("Extension context invalidated. Please refresh the page and try again.", error);
      alert("Extension context was invalidated. Please refresh the page and try again.");
    }
  }

  /**
   * Updates auto-scroll setting
   */
  setAutoScroll(enabled) {
    this.settings.autoScroll = enabled;
    chrome.storage.local.set({ autoScrollEnabled: enabled });
  }

  /**
   * Gets auto-scroll setting
   */
  getAutoScroll() {
    return this.settings.autoScroll;
  }
}